<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Commits par minute — Histogramme corrigé</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      // Récupère les commits depuis GitHub et agrège le nombre de commits par minute (0-59)
      async function fetchAndAggregateMinutes() {
        const url = "https://api.github.com/repos/marie-christ/5MCSI_Metriques/commits?per_page=100";
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Erreur lors de la récupération des commits: ${response.status} ${response.statusText}`);
        }
        const commits = await response.json();

        // Initialiser le tableau des compteurs pour chaque minute 0..59
        const counts = new Array(60).fill(0);

        commits.forEach(c => {
          // certains commits peuvent ne pas avoir la date d'auteur (rare) — on garde la date du commit
          const dateString = (c.commit && c.commit.author && c.commit.author.date) ? c.commit.author.date : null;
          if (!dateString) return;
          const date = new Date(dateString);
          if (isNaN(date)) return;
          const minute = date.getUTCMinutes(); // on utilise UTC car la date GitHub est en Z (UTC)
          counts[minute]++;
        });

        // Construire le tableau pour Google Charts: ['Minute', 'Nombre de commits']
        const dataArray = [["Minute (0-59)", "Commits"]];
        for (let m = 0; m < 60; m++) {
          dataArray.push([m, counts[m]]);
        }
        return dataArray;
      }

      // Chargement de l'API Google Charts
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(drawChart);

      async function drawChart() {
        try {
          const dataArray = await fetchAndAggregateMinutes();
          const data = google.visualization.arrayToDataTable(dataArray);

          const options = {
            title: "Nombre de commits par minute (0 → 59)",
            hAxis: { title: 'Minute (UTC)', viewWindowMode: 'explicit', viewWindow: { min: 0, max: 59 } },
            vAxis: { title: 'Commits' },
            legend: { position: 'none' },
            bar: { groupWidth: '70%' },
            height: 450,
            width: 900
          };

          // Utilisation d'un ColumnChart pour montrer clairement la répartition par minute
          const chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
          chart.draw(data, options);
        } catch (err) {
          document.getElementById('chart_div').innerText = 'Erreur: ' + err.message;
          console.error(err);
        }
      }

      // Redessiner le graphique au redimensionnement de la fenêtre
      window.addEventListener('resize', () => {
        google.charts.setOnLoadCallback(drawChart);
      });
    </script>
    <style>
      body { font-family: Arial, sans-serif; padding: 18px; }
      #chart_container { max-width: 960px; }
    </style>
  </head>
  <body>
    <h2>Commits minute par minute — dépôt: marie-christ/5MCSI_Metriques</h2>
    <p>Remarques :
      <ul>
        <li>Les dates GitHub sont en UTC (suffixe Z). Le graphique montre les minutes UTC (0-59).</li>
        <li>La requête récupère jusqu'à 100 commits (paramètre <code>per_page=100</code>).</li>
        <li>Si tu veux l'historique complet (plus de 100 commits), je peux ajouter une version serveur (Flask / Node) qui pagine toutes les pages de l'API et renvoie l'agrégation complète.</li>
      </ul>
    </p>

    <div id="chart_container">
      <div id="chart_div"></div>
    </div>
  </body>
</html>
